<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>แบบประเมินผลสัมฤทธิ์</title>
<script src="https://cdn.tailwindcss.com/3.4.17"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script>
tailwind.config = {
  theme: { extend: { fontFamily: { 'prompt': ['Prompt', 'sans-serif'] } } }
}
</script>
<style>
* { font-family: 'Prompt', sans-serif; }
html, body { height: 100%; }
#app { height: 100%; }
.likert-btn { min-width: 48px; min-height: 48px; transition: all 0.2s; font-weight: 600; border: 2px solid; }
.zebra-row:nth-child(odd)  { background-color: #F0FDFA; }
.zebra-row:nth-child(even) { background-color: #FFFFFF; }
.error-highlight { border: 2px solid #EF4444 !important; box-shadow: 0 0 0 4px rgba(239,68,68,0.1); }
.card-locked { opacity: 0.6; cursor: not-allowed; }
.toast { animation: slideIn 0.3s ease-out; }
@keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.s2-unselected { background-color:#d1d5db!important; border-color:#9ca3af!important; color:#4b5563!important; }
.s2-0 { background-color:#9ca3af!important; border-color:#6b7280!important; color:white!important; }
.s2-1 { background-color:#f87171!important; border-color:#dc2626!important; color:white!important; }
.s2-2 { background-color:#fb923c!important; border-color:#ea580c!important; color:white!important; }
.s2-3 { background-color:#fcd34d!important; border-color:#eab308!important; color:#333!important; }
.s2-4 { background-color:#bfef45!important; border-color:#65a30d!important; color:#1a1a1a!important; }
.s2-5 { background-color:#4ade80!important; border-color:#16a34a!important; color:white!important; }
.s3-unselected { background-color:#ddd6fe!important; border-color:#c4b5fd!important; color:#6b21a8!important; }
.s3-1 { background-color:#f87171!important; border-color:#dc2626!important; color:white!important; }
.s3-2 { background-color:#fb923c!important; border-color:#ea580c!important; color:white!important; }
.s3-3 { background-color:#fcd34d!important; border-color:#eab308!important; color:#333!important; }
.s3-4 { background-color:#bfef45!important; border-color:#65a30d!important; color:#1a1a1a!important; }
.s3-5 { background-color:#4ade80!important; border-color:#16a34a!important; color:white!important; }
.scale-transition { transition: all 0.3s ease; }
.score-preview {
  display: inline-block; padding: 6px 10px; background-color: #fef3c7;
  border-left: 3px solid #f59e0b; border-radius: 4px; font-size: 12px;
  color: #92400e; margin-top: 4px; font-weight: 600;
}
.sticky-header { position: sticky; top: 0; z-index: 30; }
</style>
</head>
<body class="h-full bg-gradient-to-br from-cyan-50 via-white to-teal-50 overflow-auto">
<div id="app" class="h-full w-full overflow-auto">

<!-- Toast -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- ===== LOGIN PAGE ===== -->
<div id="login-page" class="min-h-full flex items-center justify-center p-4">
  <div class="w-full max-w-md">
    <div class="bg-white rounded-3xl shadow-2xl p-8 border border-cyan-100">
      <div class="text-center mb-8">
        <div class="w-20 h-20 mx-auto mb-4 shadow-lg rounded-full overflow-hidden">
          <img src="https://img2.pic.in.th/PCC53b95442d103d70e.png" alt="Logo" class="w-full h-full object-cover">
        </div>
        <h1 class="text-lg font-bold text-gray-800 mb-2">แบบประเมินผลสัมฤทธิ์</h1>
        <p class="text-gray-600 text-xs leading-relaxed">โครงการฝึกอบรมการดูแลผู้ป่วยแบบประคับประคองขั้นพื้นฐาน สำหรับพยาบาลปฏิบัติงานหอผู้ป่วย</p>
        <p class="text-cyan-600 text-xs font-semibold mt-1">(หลักสูตร 5 วัน)</p>
      </div>
      <div class="space-y-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"></path>
            </svg>
            เลขที่ใบประกอบวิชาชีพ
          </label>
          <input type="text" id="license-input" maxlength="10" pattern="[0-9]*" inputmode="numeric"
            placeholder="กรอกตัวเลข 10 หลัก"
            class="w-full px-4 py-4 text-lg text-center tracking-widest border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:ring-4 focus:ring-cyan-100 transition-all outline-none">
          <p id="license-error" class="text-red-500 text-sm mt-2 hidden">กรุณากรอกเลขใบประกอบวิชาชีพ 10 หลัก</p>
        </div>
        <button id="login-btn" class="w-full py-4 bg-gradient-to-r from-cyan-600 to-teal-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all active:scale-95">
          เข้าสู่ระบบ
        </button>
      </div>
      <p class="text-center text-gray-400 text-xs mt-6">ข้อมูลจะถูกเก็บเป็นความลับ</p>
    </div>
  </div>
</div>

<!-- ===== TIMELINE PAGE ===== -->
<div id="timeline-page" class="hidden w-full min-h-full p-4 pb-24">
  <div class="max-w-2xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-cyan-100">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold text-gray-800">แบบประเมินผลสัมฤทธิ์</h2>
          <p class="text-gray-500 text-sm mt-1">เลขที่ใบประกอบ: <span id="display-license" class="font-medium text-cyan-600"></span></p>
        </div>
        <button id="logout-btn" class="p-2 text-gray-400 hover:text-red-500 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
          </svg>
        </button>
      </div>
    </div>

    <div class="space-y-4" id="timeline-cards">
      <!-- Pre-test -->
      <div class="assessment-card" data-round="pre">
        <div class="bg-white rounded-2xl shadow-lg border-2 border-cyan-200 overflow-hidden transition-all hover:shadow-xl">
          <div class="p-6">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-500 flex items-center justify-center flex-shrink-0 shadow-md">
                <span class="text-white font-bold text-lg">1</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-bold text-lg text-gray-800">Pre-test</h3>
                  <span class="status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">ยังไม่ทำ</span>
                </div>
                <p class="text-gray-500 text-sm">แบบประเมินก่อนการอบรม</p>
                <p class="text-gray-400 text-xs mt-2 completion-date hidden">เสร็จสิ้นเมื่อ: <span></span></p>
              </div>
              <button class="start-btn px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white font-medium rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95">เริ่มทำ</button>
            </div>
          </div>
          <div class="h-1 bg-gray-100"><div class="progress-bar h-full bg-gradient-to-r from-cyan-500 to-teal-500 transition-all duration-500" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Post-test 1 -->
      <div class="assessment-card card-locked" data-round="post1">
        <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-200 overflow-hidden transition-all">
          <div class="p-6">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-amber-500 to-orange-500 flex items-center justify-center flex-shrink-0 shadow-md">
                <span class="text-white font-bold text-lg">2</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-bold text-lg text-gray-800">Post-test 1</h3>
                  <span class="status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">รอปลดล็อค</span>
                </div>
                <p class="text-gray-500 text-sm">แบบประเมินหลังการอบรมครั้งที่ 1 (ทันที)</p>
                <p class="text-gray-400 text-xs mt-2 completion-date hidden">เสร็จสิ้นเมื่อ: <span></span></p>
              </div>
              <button class="start-btn px-6 py-3 bg-gray-300 text-gray-500 font-medium rounded-xl cursor-not-allowed" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
              </button>
            </div>
          </div>
          <div class="h-1 bg-gray-100"><div class="progress-bar h-full bg-gradient-to-r from-amber-500 to-orange-500 transition-all duration-500" style="width:0%"></div></div>
        </div>
      </div>

      <!-- Post-test 2 -->
      <div class="assessment-card card-locked" data-round="post2">
        <div class="bg-white rounded-2xl shadow-lg border-2 border-gray-200 overflow-hidden transition-all">
          <div class="p-6">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-green-500 flex items-center justify-center flex-shrink-0 shadow-md">
                <span class="text-white font-bold text-lg">3</span>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-bold text-lg text-gray-800">Post-test 2</h3>
                  <span class="status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">รอปลดล็อค</span>
                </div>
                <p class="text-gray-500 text-sm">แบบประเมินหลังการอบรมครั้งที่ 2 (3 เดือน)</p>
                <p class="text-gray-400 text-xs mt-2 completion-date hidden">เสร็จสิ้นเมื่อ: <span></span></p>
              </div>
              <button class="start-btn px-6 py-3 bg-gray-300 text-gray-500 font-medium rounded-xl cursor-not-allowed" disabled>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
              </button>
            </div>
          </div>
          <div class="h-1 bg-gray-100"><div class="progress-bar h-full bg-gradient-to-r from-emerald-500 to-green-500 transition-all duration-500" style="width:0%"></div></div>
        </div>
      </div>
    </div>

    <div id="dashboard-btn-container" class="hidden mt-6">
      <button id="view-dashboard-btn" class="w-full py-4 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all flex items-center justify-center gap-2">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
        ดูผลลัพธ์ภาพรวม
      </button>
    </div>
  </div>
</div>

<!-- ===== FORM PAGE ===== -->
<div id="form-page" class="hidden w-full min-h-full">
  <div class="sticky top-0 z-40 bg-white/95 backdrop-blur-sm shadow-md">
    <div class="max-w-4xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <button id="back-to-timeline" class="p-2 -ml-2 text-gray-600 hover:text-cyan-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
        </button>
        <div class="text-center">
          <h2 id="form-title" class="font-bold text-gray-800">แบบประเมิน</h2>
          <p class="text-xs text-gray-500">ส่วนที่ <span id="current-section">1</span>/<span id="total-section">3</span></p>
        </div>
        <div class="w-10"></div>
      </div>
      <div class="mt-3 h-2 bg-gray-200 rounded-full overflow-hidden">
        <div id="form-progress-bar" class="h-full bg-gradient-to-r from-cyan-500 to-teal-500 transition-all duration-300" style="width:0%"></div>
      </div>
    </div>
  </div>

  <div class="w-full max-w-4xl mx-auto p-4 pb-32">

    <!-- Section 1 -->
    <div id="section-1" class="form-section">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-cyan-100">
        <h3 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
          <span class="w-8 h-8 bg-cyan-100 text-cyan-600 rounded-lg flex items-center justify-center text-sm font-bold">1</span>
          ส่วนที่ 1: แบบบันทึกข้อมูลส่วนบุคคล
        </h3>
        <p class="text-gray-500 text-sm ml-10">โปรดกรอกข้อมูลส่วนบุคคลของท่านให้ครบถ้วนและถูกต้อง</p>
      </div>
      <div class="space-y-4" id="personal-info-form">

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="gender">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">1</span>เพศ
          </label>
          <div class="flex flex-wrap gap-3 ml-8">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="gender" value="male" class="w-5 h-5 text-cyan-600"><span>ชาย</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="gender" value="female" class="w-5 h-5 text-cyan-600"><span>หญิง</span></label>
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="age">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">2</span>อายุของท่าน (ปี)
          </label>
          <div class="ml-8">
            <input type="number" name="age" min="20" max="80" placeholder="กรอกอายุ" class="w-32 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:ring-2 focus:ring-cyan-100 outline-none transition-all">
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="marital_status">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">3</span>สถานภาพสมรสของท่าน
          </label>
          <div class="space-y-2 ml-8">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="marital_status" value="single" class="w-5 h-5 text-cyan-600"><span>โสด</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="marital_status" value="married" class="w-5 h-5 text-cyan-600"><span>สมรส</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="marital_status" value="divorced" class="w-5 h-5 text-cyan-600"><span>หย่าร้าง</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="marital_status" value="widowed" class="w-5 h-5 text-cyan-600"><span>หม้าย</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="marital_status" value="separated" class="w-5 h-5 text-cyan-600"><span>แยก</span></label>
            <div class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="marital_status" value="other" class="w-5 h-5 text-cyan-600"><span>อื่น ๆ</span>
              <input type="text" name="marital_status_other" placeholder="ระบุ" class="px-3 py-2 border border-gray-200 rounded-lg text-sm" style="display:none;">
            </div>
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="education">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">4</span>ระดับการศึกษาสูงสุด
          </label>
          <div class="space-y-2 ml-8">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="education" value="bachelor" class="w-5 h-5 text-cyan-600"><span>ปริญญาตรี</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="education" value="master" class="w-5 h-5 text-cyan-600"><span>ปริญญาโท</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="education" value="doctorate" class="w-5 h-5 text-cyan-600"><span>ปริญญาเอก</span></label>
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="hospital_level">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">5</span>ระดับโรงพยาบาลที่ปฏิบัติงาน
          </label>
          <div class="space-y-2 ml-8">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="hospital_level" value="community" class="w-5 h-5 text-cyan-600"><span>โรงพยาบาลชุมชน</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="hospital_level" value="general" class="w-5 h-5 text-cyan-600"><span>โรงพยาบาลทั่วไป</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="hospital_level" value="center" class="w-5 h-5 text-cyan-600"><span>โรงพยาบาลศูนย์</span></label>
            <div class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="hospital_level" value="other" class="w-5 h-5 text-cyan-600"><span>อื่น ๆ</span>
              <input type="text" name="hospital_level_other" placeholder="ระบุ" class="px-3 py-2 border border-gray-200 rounded-lg text-sm" style="display:none;">
            </div>
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="position">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">6</span>ตำแหน่งงาน
          </label>
          <div class="space-y-2 ml-8">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="position" value="head" class="w-5 h-5 text-cyan-600"><span>หัวหน้ากลุ่มงาน/หัวหน้างาน</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="position" value="chief_ward" class="w-5 h-5 text-cyan-600"><span>หัวหน้าหอผู้ป่วย/ศูนย์</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="position" value="deputy_chief" class="w-5 h-5 text-cyan-600"><span>รองหัวหน้าหอผู้ป่วย/ศูนย์</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="position" value="nurse" class="w-5 h-5 text-cyan-600"><span>พยาบาลวิชาชีพปฏิบัติงาน</span></label>
            <div class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="position" value="other" class="w-5 h-5 text-cyan-600"><span>อื่น ๆ</span>
              <input type="text" name="position_other" placeholder="ระบุ" class="px-3 py-2 border border-gray-200 rounded-lg text-sm" style="display:none;">
            </div>
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="work_experience">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">7</span>ประสบการณ์การปฏิบัติงานการพยาบาลทั้งหมด (ปี)
          </label>
          <div class="ml-8">
            <input type="number" name="work_experience" min="0" max="60" placeholder="กรอกจำนวนปี" class="w-32 px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:ring-2 focus:ring-cyan-100 outline-none transition-all">
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="pc_experience">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">8</span>เคยมีประสบการณ์การดูแลผู้ป่วยแบบประคับประคองหรือไม่
          </label>
          <div class="flex flex-wrap gap-3 ml-8">
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pc_experience" value="yes" class="w-5 h-5 text-cyan-600"><span>เคย</span></label>
            <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="pc_experience" value="no" class="w-5 h-5 text-cyan-600"><span>ไม่เคย</span></label>
          </div>
        </div>

        <div class="question-item bg-white rounded-xl shadow p-4 border border-gray-100" data-question="pc_training">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-cyan-100 text-cyan-600 rounded-full text-xs font-bold mr-2">9</span>เคยได้รับการอบรมการดูแลผู้ป่วยแบบประคับประคองหรือไม่
          </label>
          <div class="space-y-3 ml-8">
            <div class="flex items-center gap-2">
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="pc_training" value="yes" class="w-5 h-5 text-cyan-600" onchange="document.querySelector('[name=training_course]').style.display='block'">
                <span>เคย</span>
              </label>
            </div>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="pc_training" value="no" class="w-5 h-5 text-cyan-600" onchange="document.querySelector('[name=training_course]').style.display='none'">
              <span>ไม่เคย</span>
            </label>
            <input type="text" name="training_course" placeholder="ถ้าเคย ระบุชื่อหลักสูตร" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-cyan-500 focus:ring-2 focus:ring-cyan-100 outline-none transition-all" style="display:none;">
          </div>
        </div>
      </div>
    </div>

    <!-- Section 2 -->
    <div id="section-2" class="form-section hidden">
      <div class="sticky-header bg-white/95 backdrop-blur-sm shadow-md">
        <div class="max-w-4xl mx-auto p-4">
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <span class="w-8 h-8 bg-amber-100 text-amber-600 rounded-lg flex items-center justify-center text-sm font-bold">2</span>
            ส่วนที่ 2: แบบประเมินสมรรถนะการพยาบาลแบบประคับประคอง
          </h3>
          <p class="text-gray-800 text-sm mb-3">แบบประเมินนี้วัดระดับการรับรู้สมรรถนะของท่านในการให้การพยาบาลผู้ป่วยระยะประคับประคอง กรุณาประเมินความสามารถของท่านในแต่ละรายการตามความเป็นจริง</p>
          <div class="space-y-2">
            <p class="text-gray-500 text-xs font-semibold">คะแนนรวม 0-325</p>
            <div class="flex flex-wrap gap-1">
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-gray-300 rounded border border-gray-400 flex items-center justify-center text-xs font-bold text-white">0</div><span class="text-xs text-gray-600 text-center mt-1 w-12">ไม่มีความมั่นใจ</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-red-300 rounded border border-red-400 flex items-center justify-center text-xs font-bold text-white">1</div><span class="text-xs text-gray-600 text-center mt-1 w-12">มั่นใจน้อยมาก</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-orange-300 rounded border border-orange-400 flex items-center justify-center text-xs font-bold text-white">2</div><span class="text-xs text-gray-600 text-center mt-1 w-12">มั่นใจน้อย</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-yellow-300 rounded border border-yellow-400 flex items-center justify-center text-xs font-bold text-gray-700">3</div><span class="text-xs text-gray-600 text-center mt-1 w-12">มั่นใจปานกลาง</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-lime-300 rounded border border-lime-400 flex items-center justify-center text-xs font-bold text-gray-700">4</div><span class="text-xs text-gray-600 text-center mt-1 w-12">มั่นใจมาก</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-green-400 rounded border border-green-500 flex items-center justify-center text-xs font-bold text-white">5</div><span class="text-xs text-gray-600 text-center mt-1 w-12">มั่นใจมากสุด</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 mt-4" id="competency-questions"></div>
    </div>

    <!-- Section 3 -->
    <div id="section-3" class="form-section hidden">
      <div class="sticky-header bg-white/95 backdrop-blur-sm shadow-md">
        <div class="max-w-4xl mx-auto p-4">
          <h3 class="text-lg font-bold text-gray-800 mb-3 flex items-center gap-2">
            <span class="w-8 h-8 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center text-sm font-bold">3</span>
            ส่วนที่ 3: แบบสอบถามการดูแลยึดบุคคลเป็นศูนย์กลาง
          </h3>
          <p class="text-gray-600 text-sm mb-3">แบบสอบถามนี้มีวัตถุประสงค์เพื่อวัดระดับการดูแลที่เน้นผู้ป่วยเป็นศูนย์กลางภายในหน่วยงาน ตามประสบการณ์และการรับรู้ของบุคลากร กรุณาประเมินแต่ละรายการตามความเป็นจริง</p>
          <div class="space-y-2">
            <p class="text-gray-500 text-xs font-semibold">คะแนนรวม 13-65</p>
            <div class="flex flex-wrap gap-1">
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-red-300 rounded border border-red-400 flex items-center justify-center text-xs font-bold text-white">1</div><span class="text-xs text-gray-600 text-center mt-1 w-12">ไม่เห็นด้วย อย่างยิ่ง</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-orange-300 rounded border border-orange-400 flex items-center justify-center text-xs font-bold text-white">2</div><span class="text-xs text-gray-600 text-center mt-1 w-12">ไม่เห็นด้วย</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-yellow-300 rounded border border-yellow-400 flex items-center justify-center text-xs font-bold text-gray-700">3</div><span class="text-xs text-gray-600 text-center mt-1 w-12">ไม่แน่ใจ</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-lime-300 rounded border border-lime-400 flex items-center justify-center text-xs font-bold text-gray-700">4</div><span class="text-xs text-gray-600 text-center mt-1 w-12">เห็นด้วย</span></div>
              <div class="flex flex-col items-center"><div class="w-12 h-8 bg-green-400 rounded border border-green-500 flex items-center justify-center text-xs font-bold text-white">5</div><span class="text-xs text-gray-600 text-center mt-1 w-12">เห็นด้วย อย่างยิ่ง</span></div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 mt-4" id="person-centered-questions"></div>
    </div>

    <!-- Section 4 -->
    <div id="section-4" class="form-section hidden">
      <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-rose-100">
        <h3 class="text-lg font-bold text-gray-800 mb-1 flex items-center gap-2">
          <span class="w-8 h-8 bg-rose-100 text-rose-600 rounded-lg flex items-center justify-center text-sm font-bold">4</span>
          ส่วนที่ 4: ประสบการณ์การดูแลผู้ป่วยแบบประคับประคอง
        </h3>
        <p class="text-gray-500 text-sm ml-10">โปรดระบุจำนวนประมาณของผู้ป่วยที่ท่านได้ดูแลแบบประคับประคอง</p>
      </div>
      <div class="space-y-4">
        <div class="bg-white rounded-xl shadow p-6 border border-gray-100">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-rose-100 text-rose-600 rounded-full text-xs font-bold mr-2">1</span>
            ผู้ป่วยกลุ่มโรคมะเร็ง จำนวนทั้งหมด (ประมาณ)
          </label>
          <div class="flex items-center gap-3 ml-8">
            <input type="number" id="cancer-patients" name="cancer_patients" min="0" placeholder="กรอกจำนวนคน (หรือ 0)" class="flex-1 max-w-xs px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-rose-500 focus:ring-2 focus:ring-rose-100 outline-none transition-all">
            <span class="text-gray-600 font-medium">คน</span>
          </div>
        </div>
        <div class="bg-white rounded-xl shadow p-6 border border-gray-100">
          <label class="block font-medium text-gray-800 mb-3">
            <span class="inline-flex items-center justify-center w-6 h-6 bg-rose-100 text-rose-600 rounded-full text-xs font-bold mr-2">2</span>
            ผู้ป่วยไม่ใช่กลุ่มโรคมะเร็ง จำนวนทั้งหมด (ประมาณ)
          </label>
          <div class="flex items-center gap-3 ml-8">
            <input type="number" id="non-cancer-patients" name="non_cancer_patients" min="0" placeholder="กรอกจำนวนคน (หรือ 0)" class="flex-1 max-w-xs px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-rose-500 focus:ring-2 focus:ring-rose-100 outline-none transition-all">
            <span class="text-gray-600 font-medium">คน</span>
          </div>
        </div>
        <p class="text-gray-400 text-xs ml-8 mt-4">หมายเหตุ: ถ้าไม่มีใส่ 0</p>
      </div>
    </div>
  </div>

  <!-- Fixed bottom nav -->
  <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-sm border-t border-gray-200 p-4 z-40">
    <div class="max-w-4xl mx-auto flex gap-3">
      <button id="prev-section-btn" class="flex-1 py-4 bg-gray-100 text-gray-700 font-semibold rounded-xl hover:bg-gray-200 transition-all hidden">ย้อนกลับ</button>
      <button id="next-section-btn" class="flex-1 py-4 bg-gradient-to-r from-cyan-600 to-teal-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all">ถัดไป</button>
      <button id="submit-btn" class="flex-1 py-4 bg-gradient-to-r from-emerald-600 to-green-600 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transition-all hidden">ส่งแบบประเมิน</button>
    </div>
  </div>
</div>

<!-- ===== DASHBOARD PAGE ===== -->
<div id="dashboard-page" class="hidden w-full min-h-full p-4 pb-8">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-purple-100">
      <div class="flex items-center justify-between">
        <div>
          <h2 class="text-xl font-bold text-gray-800">ผลลัพธ์ภาพรวม</h2>
          <p class="text-gray-500 text-sm mt-1">เลขที่ใบประกอบ: <span id="dashboard-license" class="font-medium text-purple-600"></span></p>
        </div>
        <button id="back-to-timeline-from-dashboard" class="p-2 text-gray-400 hover:text-purple-600 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 mb-6 border border-gray-100">
      <h3 class="font-bold text-gray-800 mb-4">กราฟแสดงพัฒนาการ</h3>
      <div class="relative" style="height:350px;"><canvas id="results-chart"></canvas></div>
      <p class="text-center text-sm text-gray-500 mt-4">ขอบคุณสำหรับการประเมิน</p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 mb-6">
      <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 border-b border-gray-100">
        <h3 class="font-bold text-gray-800">ตารางสรุปคะแนน</h3>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">รายการ</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Pre-test</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Post-test 1</th>
              <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">Post-test 2</th>
            </tr>
          </thead>
          <tbody id="score-table-body"></tbody>
        </table>
      </div>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
      <div id="s2-interpretation" class="bg-gradient-to-br from-amber-50 to-orange-50 rounded-2xl shadow-lg p-6 border border-amber-200"></div>
      <div id="s3-interpretation" class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-2xl shadow-lg p-6 border border-purple-200"></div>
    </div>

    <div id="patient-experience-card" class="hidden bg-gradient-to-br from-rose-50 to-red-50 rounded-2xl shadow-lg p-6 border border-rose-200 mb-6">
      <h3 class="font-bold text-gray-800 mb-4">ประสบการณ์การดูแลผู้ป่วยแบบประคับประคอง</h3>
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-white rounded-xl p-4 border border-rose-100">
          <p class="text-sm text-gray-600">ผู้ป่วยมะเร็ง</p>
          <p id="cancer-count" class="text-2xl font-bold text-rose-600 mt-2">-</p>
          <p class="text-xs text-gray-500 mt-1">คน</p>
        </div>
        <div class="bg-white rounded-xl p-4 border border-rose-100">
          <p class="text-sm text-gray-600">ผู้ป่วยไม่ใช่มะเร็ง</p>
          <p id="non-cancer-count" class="text-2xl font-bold text-rose-600 mt-2">-</p>
          <p class="text-xs text-gray-500 mt-1">คน</p>
        </div>
      </div>
      <div class="mt-4 p-3 bg-white rounded-lg border border-rose-100">
        <p class="text-sm font-medium text-gray-700">รวมทั้งหมด: <span id="total-patients" class="text-rose-600 font-bold">-</span> คน</p>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
      <h3 class="font-bold text-gray-800 mb-4">ข้อมูลส่วนบุคคล</h3>
      <div id="personal-info-summary" class="grid grid-cols-2 sm:grid-cols-3 gap-4 text-sm"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal-overlay" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-6 transform transition-all">
    <div id="modal-icon" class="w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center"></div>
    <h3 id="modal-title" class="text-xl font-bold text-center text-gray-800 mb-2"></h3>
    <p id="modal-message" class="text-gray-500 text-center text-sm mb-6 whitespace-pre-wrap leading-relaxed"></p>
    <button id="modal-close-btn" class="w-full py-3 bg-gradient-to-r from-cyan-600 to-teal-600 text-white font-semibold rounded-xl">ตกลง</button>
  </div>
</div>

</div><!-- #app -->
<script>
// ====================================================================
// ⚠️  ตั้งค่า URL ของ Google Apps Script Web App ที่นี่
// ====================================================================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwUFNrfGZfEn0tYI01VOgkfMpyavnGgBKMAWuitemMsahfgZQmKZNWxcQwn_h3bNAZ2/exec';
// ====================================================================

// ==================== COMPETENCY QUESTIONS (65) ====================
const competencyQuestions = [
  "ท่านประเมินอาการปวดในผู้ป่วยระยะประคับประคองโดยพิจารณาองค์ประกอบต่อไปนี้ทั้งหมด : ลักษณะ  ระยะเวลา  ตำแหน่ง  ความรุนแรง  ปัจจัยกระตุ้นและปัจจัยบรรเทา",
  "ท่านประเมินอาการปวดในผู้ป่วยระยะประคับประคองที่ไม่สามารถสื่อสารได้",
  "ท่านใช้วิธีการให้ยาอย่างมีประสิทธิภาพเพื่อบรรเทาอาการปวดในผู้ป่วยระยะประคับประคอง",
  "ท่านใช้วิธีแบบไม่ใช้ยาและการบำบัดเสริมอื่นเพื่อบรรเทาอาการปวดในผู้ป่วยระยะประคับประคอง",
  "ท่านประเมินผลข้างเคียงที่เกี่ยวข้องกับยาแก้ปวดได้ตั้งแต่ระยะเริ่มต้น",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อบรรเทาอาการคลื่นไส้และอาเจียนในผู้ป่วยระยะประคับประคอง",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อบรรเทาอาการท้องผูกในผู้ป่วยระยะประคับประคอง",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อบรรเทาอาการอ่อนเพลียในผู้ป่วยระยะประคับประคอง",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อบรรเทาอาการหายใจลำบากในผู้ป่วยระยะประคับประคอง",
  "ท่านดูแลช่องปากอย่างเหมาะสมเพื่อส่งเสริมความสุขสบายในผู้ป่วยระยะประคับประคอง",
  "ท่านประเมินภาวะเพ้อสับสนในผู้ป่วยระยะประคับประคองได้อย่างทันท่วงที",
  "ท่านประเมินภาวะซึมเศร้าในผู้ป่วยระยะประคับประคองแล้วครอบครัว",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อลดความทุกข์ทางจิตใจในผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองและครอบครัวให้เผชิญกับความเครียดที่เกี่ยวข้องกับการเจ็บป่วย",
  "ท่านให้การสนับสนุนผู้ป่วยระยะประคับประคองและครอบครัวเมื่อเผชิญกับความโศกเศร้า",
  "ท่านประเมินผลกระทบของโรคที่คุกคามชีวิตต่อพลวัตของครอบครัว",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองและครอบครัวในการรักษาประเพณีทางวัฒนธรรมแม้จะมีความเจ็บป่วย",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองและครอบครัวในการระบุทรัพยากรส่วนบุคคลเพื่อรับมือกับปัญหาที่เกี่ยวข้องกับโรคที่คุกคามชีวิต",
  "ท่านส่งเสริมการสื่อสารระหว่างผู้ป่วยระยะประคับประคองและสมาชิกในครอบครัวเมื่อเกิดความขัดแย้ง",
  "ท่านส่งต่อผู้ป่วยระยะประคับประคองและครอบครัวไปยังแหล่งสนับสนุนที่เหมาะสมเพื่อตอบสนองความต้องการทางสังคม",
  "ท่านประเมินความต้องการทางจิตวิญญาณของผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านรับรู้สัญญาณของความทุกข์ทางจิตวิญญาณในผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองและครอบครัวในการค้นหาความหวังที่หลากหลายเมื่อพวกเขาแสดงสัญญาณของความสิ้นหวัง",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองในการค้นหาความหมายของประสบการณ์การเจ็บป่วยของพวกเขา",
  "ท่านปรับการพยาบาลให้สอดคล้องกับความเชื่อทางจิตวิญญาณของผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านประเมินความต้องการที่เกี่ยวข้องกับกิจกรรมในชีวิตประจำวันในผู้ป่วยระยะประคับประคอง",
  "ท่านประเมินความต้องการการสนับสนุนด้านการดูแลผู้ป่วยเพื่อป้องกันภาวะหมดไฟในสมาชิกครอบครัวที่ดูแลผู้ป่วยระยะประคับประคอง",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองในการรักษาความเป็นอิสระในการทำกิจกรรมให้นานที่สุดเท่าที่เป็นไปได้",
  "ท่านเสริมสร้างพลังของสมาชิกครอบครัวในการให้การดูแลผู้ป่วยระยะประคับประคอง",
  "ท่านดำเนินการด้วยวิธีที่เหมาะสมเพื่อช่วยบรรเทาภาระของสมาชิกครอบครัวที่ดูแลผู้ป่วยระยะประคับประคอง",
  "ท่านระบุประเด็นทางจริยธรรมที่เกี่ยวข้องกับการดูแลผู้ป่วยระยะประคับประคองได้อย่างทันท่วงที",
  "ท่านให้ข้อมูลแก่ผู้ป่วยระยะประคับประคองเกี่ยวกับประเด็นทางกฎหมายที่เกี่ยวข้องกับโรคที่คุกคามชีวิต",
  "ท่านช่วยเหลือผู้ป่วยระยะประคับประคองในการตัดสินใจอย่างถ่อมตัวเกี่ยวกับการดูแลในช่วงท้ายของชีวิต",
  "ท่านทำหน้าที่เป็นผู้พิทักษ์สิทธิของผู้ป่วยระยะประคับประคองและครอบครัวกับสมาชิกคนอื่นๆ  ในทีมสุขภาพ",
  "ท่านทำหน้าที่เป็นผู้พิทักษ์สิทธิของผู้ป่วยระยะประคับประคองเมื่อมีความเห็นแตกต่างกันกับครอบครัวเกี่ยวกับประเด็นการดูแล",
  "ท่านมีส่วนร่วมอย่างแข็งขันในการอภิปรายเกี่ยวกับสถานการณ์ทางคลินิกของผู้ป่วยระยะประคับประคองในระหว่างการประชุมทีมสหวิชาชีพ",
  "ท่านส่งเสริมการสื่อสารระหว่างบุคลากรสุขภาพเกี่ยวกับผู้ป่วยระยะประคับประคองเพื่อสนับสนุนความต่อเนื่องของการดูแล",
  "ท่านส่งเสริมการสื่อสารระหว่างผู้ป่วยระยะประคับประคอง  ครอบครัว  และบุคลากรสุขภาพเพื่อให้มั่นใจในการแลกเปลี่ยนข้อมูล",
  "ท่านส่งเสริมการสื่อสารระหว่างบุคลากรสุขภาพเมื่อเกิดความขัดแย้งในการดูแลผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านส่งเสริมความร่วมมือของสหสาขาวิชาชีพในการดูแลผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านรับรู้ว่าความเชื่อส่วนบุคคลและทางวิชาชีพของท่านจะมีอิทธิพลต่อการดูแลที่ท่านให้กับผู้ป่วยระยะประคับประคองและครอบครัวอย่างมาก",
  "ท่านเผชิญกับการสูญเสียและความโศกเศร้าที่เกี่ยวข้องกับการดูแลผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านระบุปัจจัยกระตุ้นที่ส่งผลกระทบเมื่อท่านให้การดูแลผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านระบุแหล่งประโยชน์ของท่านเองเพื่อจัดการกับความเครียดที่เกี่ยวข้องกับการดูแลผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านสนทนาเรื่องความตายและการจากไปกับผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อบรรเทาอาการปวดในผู้ป่วยระยะประคับประคองในช่วงชั่วโมงสุดท้ายของชีวิต",
  "ท่านให้การดูแลอย่างมีประสิทธิภาพเพื่อบรรเทาอาการหายใจลำบากในช่วงชั่วโมงสุดท้ายของชีวิต",
  "ท่านสามารถระบุสัญญาณและอาการของระยะใกล้เสียชีวิตในผู้ป่วยระยะประคับประคอง",
  "ท่านแสดงความจริงใจในการอยู่เคียงข้างในช่วงชั่วโมงสุดท้ายของชีวิตกับผู้ป่วยระยะประคับประคองและครอบครัว",
  "ท่านส่งเสริมการปฏิบัติทางประเพณี  วัฒนธรรม  และศาสนาสำหรับผู้ป่วยระยะประคับประคองและครอบครัวในช่วงชั่วโมงสุดท้ายของชีวิต",
  "ท่านให้การดูแลผู้ป่วยและครอบครัวแบบองค์รวม  ครอบคลุมทั้งด้านร่างกาย  จิตใจ  สังคม  และจิตวิญญาณ",
  "ท่านประยุกต์ใช้ปรัชญาและเป้าหมายของการดูแลแบบประคับประคองในการปฏิบัติการพยาบาล",
  "ท่านให้การดูแลผู้ป่วยและครอบครัวอย่างต่อเนื่องตั้งแต่เริ่มวินิจฉัยโรคจนถึงภายหลังการเสียชีวิต",
  "ท่านส่งเสริมคุณภาพชีวิตของผู้ป่วยและครอบครัวในทุกช่วงของการเจ็บป่วย",
  "ท่านอธิบายกลไกของความปวดและอาการรบกวนอื่นๆ  แก่ผู้ป่วยและครอบครัวได้อย่างเข้าใจง่าย",
  "ท่านประเมินอาการรบกวนอื่นๆ  ได้อย่างเหมาะสม  เช่น  อ่อนแรง  เบื่ออาหาร  นอนไม่หลับ",
  "ท่านประยุกต์ใช้การรักษาทั้งด้วยยาและไม่ใช้ยาเพื่อลดความทุกข์ทรมานและส่งเสริมความสุขสบายของผู้ป่วย",
  "ท่านเข้าใจกระบวนการตายและสามารถอธิบายให้ผู้ป่วยและครอบครัวเข้าใจได้",
  "ท่านเตรียมผู้ป่วยและครอบครัวต่อการเปลี่ยนแปลงทางร่างกายและจิตใจในระยะสุดท้ายของชีวิต",
  "ท่านดูแลร่างกายผู้ป่วยภายหลังเสียชีวิตอย่างสุภาพ  เคารพศักดิ์ศรี  และเหมาะสมตามวัฒนธรรม",
  "ท่านประเมินและให้การช่วยเหลือครอบครัวในการเผชิญความสูญเสียทั้งก่อนและหลังผู้ป่วยเสียชีวิต",
  "ท่านแยกแยะความเศร้าโศกตามธรรมชาติกับภาวะซึมเศร้าที่ต้องการการรักษา",
  "ท่านส่งต่อครอบครัวไปยังผู้เชี่ยวชาญด้านสุขภาพจิตหรือการให้คำปรึกษาเมื่อจำเป็น",
  "ท่านให้การสนับสนุนครอบครัวในระยะหลังการสูญเสียอย่างต่อเนื่องและเหมาะสม",
  "ท่านใช้ทักษะการสื่อสารเชิงบำบัดในการดูแลผู้ป่วยและครอบครัวอย่างมีประสิทธิผล"
];

// ==================== PERSON-CENTERED QUESTIONS (13) ====================
const personCenteredQuestions = [
  "เรามักพูดคุยกันอยู่เสมอเกี่ยวกับวิธีการให้การดูแลที่เน้นผู้ป่วยเป็นศูนย์กลาง",
  "เรามีการประชุมทีมอย่างเป็นทางการเพื่อหารือเกี่ยวกับการดูแลผู้ป่วย",
  "ประวัติชีวิตของผู้ป่วยถูกนำมาใช้อย่างเป็นทางการในแผนการดูแล",
  "คุณภาพของปฏิสัมพันธ์ระหว่างบุคลากรและผู้ป่วยมีความสำคัญมากกว่าการทำงานให้เสร็จ",
  "เรามีอิสระในการปรับเปลี่ยนกิจวัตรการทำงานตามความพึงพอใจของผู้ป่วย",
  "ผู้ป่วยได้รับโอกาสในการมีส่วนร่วมในกิจกรรมประจำวันเฉพาะบุคคล",
  "ท่านไม่มีเวลาเพียงพอที่จะให้การดูแลที่เน้นผู้ป่วยเป็นศูนย์กลาง",
  "สภาพแวดล้อมการทำงานในหน่วยงานให้ความรู้สึกสับสนวุ่นวาย",
  "เราต้องทำงานให้เสร็จก่อนจึงจะให้ความสำคัญกับสภาพแวดล้อมที่อบอุ่นเหมือนบ้าน",
  "หน่วยงานเป็นอุปสรรคที่ทำให้ฉันไม่สามารถให้การดูแลที่เน้นผู้ป่วยเป็นศูนย์กลางได้",
  "การประเมินความต้องการของผู้ป่วยถูกดำเนินการเป็นประจำทุกวัน",
  "ผู้ป่วยในหน่วยงานของท่านหาทางเดินไปมาได้ยาก",
  "ผู้ป่วยในหน่วยงานของท่านสามารถเข้าถึงพื้นที่กลางภายนอกได้ตามที่ต้องการ"
];

// ==================== STATE ====================
let currentUser = null;
let currentRound = null;
let currentSection = 1;
let formAnswers = { section1: {}, section2: [], section3: [], section4: {} };
let resultsChart = null;

// ==================== API ====================
async function apiGet(license) {
  try {
    const url = SCRIPT_URL + '?action=get&license=' + encodeURIComponent(license);
    const r = await fetch(url);
    const json = await r.json();
    return Array.isArray(json) ? json : [];
  } catch(e) { return []; }
}

async function apiCreate(data) {
  const url = SCRIPT_URL + '?action=create&data=' + encodeURIComponent(JSON.stringify(data));
  const r = await fetch(url);
  return r.json();
}

// ==================== UTILITY ====================
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  const colors = { success:'bg-emerald-500', error:'bg-red-500', info:'bg-cyan-500', warning:'bg-amber-500' };
  toast.className = `toast ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2`;
  const icons = {
    success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
    error:   '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
    info:    '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>',
    warning: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>'
  };
  toast.innerHTML = `<svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icons[type]||icons.info}</svg><span>${message}</span>`;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

function showModal(title, message, type = 'info') {
  const overlay = document.getElementById('modal-overlay');
  const iconDiv = document.getElementById('modal-icon');
  const icons = {
    success: { bg:'bg-emerald-100', color:'text-emerald-600', path:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>' },
    error:   { bg:'bg-red-100',     color:'text-red-600',     path:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' },
    info:    { bg:'bg-cyan-100',    color:'text-cyan-600',    path:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>' },
    warning: { bg:'bg-amber-100',   color:'text-amber-600',   path:'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>' }
  };
  const icon = icons[type] || icons.info;
  iconDiv.className = `w-16 h-16 mx-auto mb-4 rounded-full flex items-center justify-center ${icon.bg}`;
  iconDiv.innerHTML = `<svg class="w-8 h-8 ${icon.color}" fill="none" stroke="currentColor" viewBox="0 0 24 24">${icon.path}</svg>`;
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-message').textContent = message;
  overlay.classList.remove('hidden');
}
function hideModal() { document.getElementById('modal-overlay').classList.add('hidden'); }

function formatDate(date) {
  if (!date) return '-';
  return new Date(date).toLocaleDateString('th-TH', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
}

function getInterpretation(section, score) {
  if (section === 2) {
    if (score < 81.25)  return { level:'น้อยมาก', color:'text-red-600',    bg:'bg-red-50' };
    if (score < 162.5)  return { level:'น้อย',     color:'text-orange-600', bg:'bg-orange-50' };
    if (score < 243.75) return { level:'ปานกลาง',  color:'text-amber-600',  bg:'bg-amber-50' };
    return { level:'มาก', color:'text-emerald-600', bg:'bg-emerald-50' };
  } else {
    if (score < 16.25)  return { level:'น้อยมาก', color:'text-red-600',    bg:'bg-red-50' };
    if (score < 32.5)   return { level:'น้อย',     color:'text-orange-600', bg:'bg-orange-50' };
    if (score < 48.75)  return { level:'ปานกลาง',  color:'text-amber-600',  bg:'bg-amber-50' };
    return { level:'มาก', color:'text-emerald-600', bg:'bg-emerald-50' };
  }
}

// ==================== PAGE NAV ====================
function showPage(pageId) {
  document.querySelectorAll('#app > div[id$="-page"]').forEach(p => p.classList.add('hidden'));
  const page = document.getElementById(pageId);
  if (page) { page.classList.remove('hidden'); page.scrollTo ? page.scrollTo(0,0) : window.scrollTo(0,0); }
}

// ==================== LOGIN ====================
function initLogin() {
  const input = document.getElementById('license-input');
  input.addEventListener('input', e => {
    e.target.value = e.target.value.replace(/\D/g,'').slice(0,10);
    document.getElementById('license-error').classList.add('hidden');
  });
  document.getElementById('login-btn').addEventListener('click', handleLogin);
  input.addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
}

async function handleLogin() {
  const input = document.getElementById('license-input');
  const licenseNumber = input.value.trim();
  if (licenseNumber.length !== 10) {
    document.getElementById('license-error').classList.remove('hidden');
    input.classList.add('error-highlight');
    setTimeout(() => input.classList.remove('error-highlight'), 1000);
    return;
  }
  const btn = document.getElementById('login-btn');
  btn.textContent = 'กำลังโหลด...';
  btn.disabled = true;
  try {
    const records = await apiGet(licenseNumber);
    buildUserFromRecords(licenseNumber, records);
  } catch(e) {
    buildUserFromRecords(licenseNumber, []);
    showToast('ไม่สามารถเชื่อมต่อ server ข้อมูลอาจไม่ถูกบันทึก', 'warning');
  }
  btn.textContent = 'เข้าสู่ระบบ';
  btn.disabled = false;
  showTimeline();
}

function buildUserFromRecords(licenseNumber, records) {
  currentUser = {
    licenseNumber,
    personalInfo: null,
    rounds: {
      pre:   { completed:false, date:null, scores:{section2:0,section3:0}, patients:{cancer:0,non_cancer:0} },
      post1: { completed:false, date:null, scores:{section2:0,section3:0}, patients:{cancer:0,non_cancer:0} },
      post2: { completed:false, date:null, scores:{section2:0,section3:0}, patients:{cancer:0,non_cancer:0} }
    }
  };
  if (records.length > 0) {
    const r = records[0];
    currentUser.personalInfo = {
      gender:r.gender, age:r.age, marital_status:r.marital_status,
      education:r.education, hospital_level:r.hospital_level,
      position:r.position, work_experience:r.work_experience,
      pc_experience:r.pc_experience, pc_training:r.pc_training,
      training_course:r.training_course
    };
  }
  records.forEach(record => {
    const rnd = record.round;
    if (!['pre','post1','post2'].includes(rnd)) return;
    currentUser.rounds[rnd] = {
      completed: true,
      date: record.assessment_date,
      scores: { section2: Number(record.section2_score)||0, section3: Number(record.section3_score)||0 },
      patients: { cancer: Number(record.cancer_patients)||0, non_cancer: Number(record.non_cancer_patients)||0 }
    };
  });
}

// ==================== TIMELINE ====================
function showTimeline() {
  showPage('timeline-page');
  document.getElementById('display-license').textContent = currentUser.licenseNumber;
  updateTimelineCards();
}

function updateTimelineCards() {
  const rounds = ['pre','post1','post2'];
  rounds.forEach((round, index) => {
    const card = document.querySelector(`.assessment-card[data-round="${round}"]`);
    const status = card.querySelector('.status-badge');
    const btn = card.querySelector('.start-btn');
    const dateEl = card.querySelector('.completion-date');
    const progressBar = card.querySelector('.progress-bar');
    const cardContainer = card.querySelector('.bg-white');
    const roundData = currentUser.rounds[round];
    const prevRound = index > 0 ? rounds[index-1] : null;
    const isUnlocked = !prevRound || currentUser.rounds[prevRound].completed;

    card.classList.toggle('card-locked', !isUnlocked);
    cardContainer.classList.remove('border-cyan-200','border-amber-200','border-emerald-200','border-gray-200');
    const borderClasses = ['border-cyan-200','border-amber-200','border-emerald-200'];
    cardContainer.classList.add(isUnlocked ? borderClasses[index] : 'border-gray-200');

    if (roundData.completed) {
      status.textContent = 'เสร็จสิ้น';
      status.className = 'status-badge px-3 py-1 rounded-full text-xs font-medium bg-emerald-100 text-emerald-600';
      btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
      btn.className = 'start-btn p-3 bg-emerald-100 text-emerald-600 rounded-xl';
      btn.disabled = true;
      dateEl.classList.remove('hidden');
      dateEl.querySelector('span').textContent = formatDate(roundData.date);
      progressBar.style.width = '100%';
    } else if (isUnlocked) {
      status.textContent = 'ยังไม่ทำ';
      status.className = 'status-badge px-3 py-1 rounded-full text-xs font-medium bg-cyan-100 text-cyan-600';
      btn.textContent = 'เริ่มทำ';
      btn.className = 'start-btn px-6 py-3 bg-gradient-to-r from-cyan-500 to-teal-500 text-white font-medium rounded-xl shadow-md hover:shadow-lg transition-all active:scale-95';
      btn.disabled = false;
      btn.onclick = () => startAssessment(round);
      dateEl.classList.add('hidden');
      progressBar.style.width = '0%';
    } else {
      status.textContent = 'รอปลดล็อค';
      status.className = 'status-badge px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600';
      btn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>`;
      btn.className = 'start-btn px-6 py-3 bg-gray-300 text-gray-500 font-medium rounded-xl cursor-not-allowed';
      btn.disabled = true;
      dateEl.classList.add('hidden');
      progressBar.style.width = '0%';
    }
  });
  const allCompleted = rounds.every(r => currentUser.rounds[r].completed);
  document.getElementById('dashboard-btn-container').classList.toggle('hidden', !allCompleted);
}

// ==================== FORM ====================
function startAssessment(round) {
  currentRound = round;
  currentSection = currentUser.personalInfo ? 2 : 1;
  formAnswers = { section1:{}, section2:[], section3:[], section4:{} };
  if (currentUser.personalInfo) formAnswers.section1 = { ...currentUser.personalInfo };

  const titles = { pre:'Pre-test', post1:'Post-test 1', post2:'Post-test 2' };
  document.getElementById('form-title').textContent = `แบบประเมิน ${titles[currentRound]}`;
  const totalSec = (currentUser.personalInfo ? 0 : 1) + 2 + (currentRound === 'post2' ? 1 : 0);
  document.getElementById('total-section').textContent = totalSec;

  showPage('form-page');
  generateQuestions();
  showSection(currentSection);
  updateFormProgress();
}

function generateQuestions() {
  // Section 2
  document.getElementById('competency-questions').innerHTML = competencyQuestions.map((q,i) => {
    const cv = formAnswers.section2[i];
    return `<div class="question-row zebra-row p-4 border-b border-gray-100" data-question="s2_${i}">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <div class="flex-1">
          <span class="inline-flex items-center justify-center w-8 h-8 bg-amber-100 text-amber-600 rounded-lg text-sm font-bold mr-2">${i+1}</span>
          <span class="text-gray-700 text-sm">${q}</span>
          ${cv !== undefined ? `<div class="score-preview">เลือก: ระดับ ${cv}</div>` : ''}
        </div>
        <div class="flex gap-1 justify-end flex-wrap min-w-fit">
          ${[0,1,2,3,4,5].map(score => `<button type="button" class="likert-btn s2-${cv===score?score:'unselected'}" data-section="2" data-index="${i}" data-value="${score}" onclick="selectLikert(this)" title="${['ไม่มีความมั่นใจเลย','มั่นใจน้อยมาก','มั่นใจน้อย','มั่นใจปานกลาง','มั่นใจมาก','มั่นใจมากที่สุด'][score]}">${score}</button>`).join('')}
        </div>
      </div>
    </div>`;
  }).join('');

  // Section 3
  document.getElementById('person-centered-questions').innerHTML = personCenteredQuestions.map((q,i) => {
    const cv = formAnswers.section3[i];
    return `<div class="question-row zebra-row p-4 border-b border-gray-100" data-question="s3_${i}">
      <div class="flex flex-col sm:flex-row sm:items-center gap-3">
        <div class="flex-1">
          <span class="inline-flex items-center justify-center w-8 h-8 bg-purple-100 text-purple-600 rounded-lg text-sm font-bold mr-2">${i+1}</span>
          <span class="text-gray-700 text-sm">${q}</span>
          ${cv !== undefined ? `<div class="score-preview">เลือก: ระดับ ${cv}</div>` : ''}
        </div>
        <div class="flex gap-1 justify-end flex-wrap min-w-fit">
          ${[1,2,3,4,5].map(score => `<button type="button" class="likert-btn s3-${cv===score?score:'unselected'}" data-section="3" data-index="${i}" data-value="${score}" onclick="selectLikert(this)" title="${['','ไม่เห็นด้วยอย่างยิ่ง','ไม่เห็นด้วย','ไม่แน่ใจ','เห็นด้วย','เห็นด้วยอย่างยิ่ง'][score]}">${score}</button>`).join('')}
        </div>
      </div>
    </div>`;
  }).join('');
}

function selectLikert(btn) {
  const section = parseInt(btn.dataset.section);
  const index   = parseInt(btn.dataset.index);
  const value   = parseInt(btn.dataset.value);
  btn.closest('.question-row').classList.remove('error-highlight');
  btn.parentElement.querySelectorAll('.likert-btn').forEach(b => {
    b.classList.remove('s2-0','s2-1','s2-2','s2-3','s2-4','s2-5','s3-1','s3-2','s3-3','s3-4','s3-5','s2-unselected','s3-unselected');
    b.classList.add(section === 2 ? 's2-unselected' : 's3-unselected');
  });
  btn.classList.remove('s2-unselected','s3-unselected');
  btn.classList.add(section === 2 ? `s2-${value}` : `s3-${value}`);
  if (section === 2) formAnswers.section2[index] = value;
  else formAnswers.section3[index] = value;
  const levels = {
    s2: ['ไม่มีความมั่นใจเลย','มั่นใจน้อยมาก','มั่นใจน้อย','มั่นใจปานกลาง','มั่นใจมาก','มั่นใจมากที่สุด'],
    s3: ['','ไม่เห็นด้วยอย่างยิ่ง','ไม่เห็นด้วย','ไม่แน่ใจ','เห็นด้วย','เห็นด้วยอย่างยิ่ง']
  };
  const sp = btn.closest('.question-row').querySelector('.score-preview');
  if (sp) sp.textContent = `เลือก: ระดับ ${value} - ${section===2?levels.s2[value]:levels.s3[value]}`;
  updateFormProgress();
}

function showSection(sectionNum) {
  currentSection = sectionNum;
  document.getElementById('current-section').textContent = sectionNum;
  document.querySelectorAll('.form-section').forEach((s,i) => s.classList.toggle('hidden', i+1 !== sectionNum));
  const startSection  = currentUser.personalInfo ? 2 : 1;
  const totalSections = (currentUser.personalInfo ? 0 : 1) + 2 + (currentRound === 'post2' ? 1 : 0);
  document.getElementById('prev-section-btn').classList.toggle('hidden', sectionNum <= startSection);
  document.getElementById('next-section-btn').classList.toggle('hidden', sectionNum === totalSections);
  document.getElementById('submit-btn').classList.toggle('hidden', sectionNum !== totalSections);
  document.getElementById('form-page').scrollTo({ top:0, behavior:'smooth' });
}

function updateFormProgress() {
  const startSection  = currentUser.personalInfo ? 2 : 1;
  const totalSections = (currentUser.personalInfo ? 0 : 1) + 2 + (currentRound === 'post2' ? 1 : 0);
  const completedSections = currentSection - startSection;
  let sp = 0;
  if      (currentSection === 1) sp = Object.keys(formAnswers.section1).length / 9;
  else if (currentSection === 2) sp = formAnswers.section2.filter(a=>a!==undefined).length / competencyQuestions.length;
  else if (currentSection === 3) sp = formAnswers.section3.filter(a=>a!==undefined).length / personCenteredQuestions.length;
  else if (currentSection === 4) sp = ((formAnswers.section4.cancer_patients!==undefined?1:0)+(formAnswers.section4.non_cancer_patients!==undefined?1:0)) / 2;
  document.getElementById('form-progress-bar').style.width = `${((completedSections + sp) / totalSections) * 100}%`;
}

function validateSection(sectionNum) {
  let isValid = true, firstError = null;
  if (sectionNum === 1) {
    const fields = ['gender','age','marital_status','education','hospital_level','position','work_experience','pc_experience','pc_training'];
    fields.forEach(field => {
      const container = document.querySelector(`[data-question="${field}"]`);
      let hasValue = false;
      if (['gender','marital_status','education','hospital_level','position','pc_experience','pc_training'].includes(field)) {
        const checked = container.querySelector('input[type="radio"]:checked');
        hasValue = checked !== null;
        if (hasValue) {
          if (checked.value === 'other') {
            const oi = container.querySelector(`input[name="${field}_other"]`);
            hasValue = oi && oi.value.trim() !== '';
            if (hasValue) formAnswers.section1[field] = oi.value.trim();
          } else { formAnswers.section1[field] = checked.value; }
        }
      } else {
        const el = container.querySelector('input[type="number"],input[type="text"]');
        hasValue = el && el.value.trim() !== '';
        if (hasValue) formAnswers.section1[field] = el.value.trim();
      }
      if (!hasValue) { isValid=false; container.classList.add('error-highlight'); if(!firstError)firstError=container; }
      else container.classList.remove('error-highlight');
    });
  } else if (sectionNum === 2) {
    competencyQuestions.forEach((_,i) => {
      const row = document.querySelector(`[data-question="s2_${i}"]`);
      if (formAnswers.section2[i] === undefined) { isValid=false; row.classList.add('error-highlight'); if(!firstError)firstError=row; }
      else row.classList.remove('error-highlight');
    });
  } else if (sectionNum === 3) {
    personCenteredQuestions.forEach((_,i) => {
      const row = document.querySelector(`[data-question="s3_${i}"]`);
      if (formAnswers.section3[i] === undefined) { isValid=false; row.classList.add('error-highlight'); if(!firstError)firstError=row; }
      else row.classList.remove('error-highlight');
    });
  } else if (sectionNum === 4) {
    const ci = document.getElementById('cancer-patients');
    const ni = document.getElementById('non-cancer-patients');
    if (ci.value.trim()==='') { isValid=false; ci.classList.add('error-highlight'); if(!firstError)firstError=ci; }
    else { ci.classList.remove('error-highlight'); formAnswers.section4.cancer_patients = parseInt(ci.value)||0; }
    if (ni.value.trim()==='') { isValid=false; ni.classList.add('error-highlight'); if(!firstError)firstError=ni; }
    else { ni.classList.remove('error-highlight'); formAnswers.section4.non_cancer_patients = parseInt(ni.value)||0; }
  }
  if (!isValid && firstError) {
    firstError.scrollIntoView({ behavior:'smooth', block:'center' });
    showToast('กรุณาตอบคำถามให้ครบทุกข้อ', 'warning');
  }
  return isValid;
}

function calculateScores() {
  return {
    section2: formAnswers.section2.reduce((a,b) => a + (b||0), 0),
    section3: formAnswers.section3.reduce((a,b) => a + (b||0), 0)
  };
}

async function submitAssessment() {
  const totalSections = (currentUser.personalInfo ? 0 : 1) + 2 + (currentRound === 'post2' ? 1 : 0);
  if (!validateSection(totalSections)) return;

  const scores = calculateScores();
  if (!currentUser.personalInfo) currentUser.personalInfo = { ...formAnswers.section1 };

  currentUser.rounds[currentRound] = {
    completed: true,
    date: new Date().toISOString(),
    scores,
    patients: currentRound === 'post2'
      ? { cancer: formAnswers.section4.cancer_patients||0, non_cancer: formAnswers.section4.non_cancer_patients||0 }
      : { cancer:0, non_cancer:0 }
  };

  const interp2 = getInterpretation(2, scores.section2);
  const interp3 = getInterpretation(3, scores.section3);

  const record = {
    license_number: currentUser.licenseNumber,
    round: currentRound,
    ...currentUser.personalInfo,
    section2_score: scores.section2,
    section3_score: scores.section3,
    interpretation_s2: interp2.level,
    interpretation_s3: interp3.level,
    cancer_patients: currentUser.rounds[currentRound].patients.cancer,
    non_cancer_patients: currentUser.rounds[currentRound].patients.non_cancer,
    assessment_date: new Date().toISOString()
  };
  formAnswers.section2.forEach((v,i) => record[`section2_q${i+1}`] = v||0);
  formAnswers.section3.forEach((v,i) => record[`section3_q${i+1}`] = v||0);

  try {
    const result = await apiCreate(record);
    if (result && result.isOk !== false) {
      showModal(
        'บันทึกสำเร็จ!',
        `สมรรถนะการพยาบาล: ${scores.section2}/325 ระดับ${interp2.level}\nการดูแลยึดบุคคลเป็นศูนย์กลาง: ${scores.section3}/65 ระดับ${interp3.level}`,
        'success'
      );
      document.getElementById('modal-close-btn').onclick = () => { hideModal(); showTimeline(); };
    } else {
      showToast('เกิดข้อผิดพลาดในการบันทึกข้อมูล', 'error');
    }
  } catch(e) {
    showToast('เกิดข้อผิดพลาด: ' + e.message, 'error');
  }
}

// ==================== DASHBOARD ====================
function showDashboard() {
  showPage('dashboard-page');
  document.getElementById('dashboard-license').textContent = currentUser.licenseNumber;
  renderChart();
  renderScoreTable();
  renderInterpretations();
  renderPersonalInfoSummary();
  renderPatientExperience();
}

function renderChart() {
  const ctx = document.getElementById('results-chart').getContext('2d');
  if (resultsChart) resultsChart.destroy();
  resultsChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Pre-test','Post-test 1','Post-test 2'],
      datasets: [
        {
          label: 'ส่วนที่ 2: สมรรถนะการพยาบาล (0-325)',
          data: [currentUser.rounds.pre.scores.section2, currentUser.rounds.post1.scores.section2, currentUser.rounds.post2.scores.section2],
          borderColor:'#F59E0B', backgroundColor:'rgba(245,158,11,0.1)',
          tension:0.4, fill:true, pointRadius:7, pointBackgroundColor:'#F59E0B', pointBorderColor:'#fff', pointBorderWidth:2
        },
        {
          label: 'ส่วนที่ 3: การดูแลยึดบุคคลเป็นศูนย์กลาง (13-65)',
          data: [currentUser.rounds.pre.scores.section3, currentUser.rounds.post1.scores.section3, currentUser.rounds.post2.scores.section3],
          borderColor:'#A855F7', backgroundColor:'rgba(168,85,247,0.1)',
          tension:0.4, fill:true, pointRadius:7, pointBackgroundColor:'#A855F7', pointBorderColor:'#fff', pointBorderWidth:2
        }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      plugins: {
        legend: { position:'bottom', labels:{ font:{size:13}, padding:20, usePointStyle:true } },
        tooltip: {
          callbacks: {
            label: ctx => {
              const v = ctx.parsed.y;
              const s = ctx.datasetIndex === 0 ? 2 : 3;
              return `${ctx.dataset.label}: ${v} : ระดับ${getInterpretation(s,v).level}`;
            }
          }
        }
      },
      scales: {
        y: { beginAtZero:true, max:325, grid:{ color:'rgba(0,0,0,0.05)' } },
        x: { grid:{ display:false } }
      }
    }
  });
}

function renderScoreTable() {
  document.getElementById('score-table-body').innerHTML = `
    <tr class="border-b">
      <td class="px-4 py-3 font-medium text-gray-700">ส่วนที่ 2: สมรรถนะการพยาบาล</td>
      <td class="px-4 py-3 text-center font-semibold text-amber-600">${currentUser.rounds.pre.scores.section2}/325</td>
      <td class="px-4 py-3 text-center font-semibold text-amber-600">${currentUser.rounds.post1.scores.section2}/325</td>
      <td class="px-4 py-3 text-center font-semibold text-amber-600">${currentUser.rounds.post2.scores.section2}/325</td>
    </tr>
    <tr class="border-b bg-gray-50">
      <td class="px-4 py-3 font-medium text-gray-700">ส่วนที่ 3: การดูแลยึดบุคคลเป็นศูนย์กลาง</td>
      <td class="px-4 py-3 text-center font-semibold text-purple-600">${currentUser.rounds.pre.scores.section3}/65</td>
      <td class="px-4 py-3 text-center font-semibold text-purple-600">${currentUser.rounds.post1.scores.section3}/65</td>
      <td class="px-4 py-3 text-center font-semibold text-purple-600">${currentUser.rounds.post2.scores.section3}/65</td>
    </tr>
    <tr>
      <td class="px-4 py-3 font-medium text-gray-700">วันที่ทำแบบประเมิน</td>
      <td class="px-4 py-3 text-center text-sm text-gray-500">${formatDate(currentUser.rounds.pre.date)}</td>
      <td class="px-4 py-3 text-center text-sm text-gray-500">${formatDate(currentUser.rounds.post1.date)}</td>
      <td class="px-4 py-3 text-center text-sm text-gray-500">${formatDate(currentUser.rounds.post2.date)}</td>
    </tr>`;
}

function renderInterpretations() {
  const rounds = ['pre','post1','post2'];
  const labels = { pre:'Pre-test', post1:'Post-test 1', post2:'Post-test 2' };

  document.getElementById('s2-interpretation').innerHTML = `
    <h4 class="font-bold text-gray-800 mb-3">ส่วนที่ 2: สมรรถนะการพยาบาล</h4>
    <div class="space-y-2 text-sm">
      ${rounds.map(r => {
        const interp = getInterpretation(2, currentUser.rounds[r].scores.section2);
        return `<div class="flex justify-between items-center p-2 bg-white rounded">
          <span>${labels[r]}</span>
          <span class="font-semibold ${interp.color}">${currentUser.rounds[r].scores.section2} (${interp.level})</span>
        </div>`;
      }).join('')}
    </div>`;

  document.getElementById('s3-interpretation').innerHTML = `
    <h4 class="font-bold text-gray-800 mb-3">ส่วนที่ 3: การดูแลยึดบุคคลเป็นศูนย์กลาง</h4>
    <div class="space-y-2 text-sm">
      ${rounds.map(r => {
        const interp = getInterpretation(3, currentUser.rounds[r].scores.section3);
        return `<div class="flex justify-between items-center p-2 bg-white rounded">
          <span>${labels[r]}</span>
          <span class="font-semibold ${interp.color}">${currentUser.rounds[r].scores.section3} (${interp.level})</span>
        </div>`;
      }).join('')}
    </div>`;
}

function renderPatientExperience() {
  const card = document.getElementById('patient-experience-card');
  if (currentUser.rounds.post2.completed) {
    card.classList.remove('hidden');
    document.getElementById('cancer-count').textContent = currentUser.rounds.post2.patients.cancer;
    document.getElementById('non-cancer-count').textContent = currentUser.rounds.post2.patients.non_cancer;
    document.getElementById('total-patients').textContent = currentUser.rounds.post2.patients.cancer + currentUser.rounds.post2.patients.non_cancer;
  } else {
    card.classList.add('hidden');
  }
}

function renderPersonalInfoSummary() {
  const container = document.getElementById('personal-info-summary');
  const info = currentUser.personalInfo;
  if (!info) { container.innerHTML = '<p class="text-gray-500">ไม่มีข้อมูลส่วนบุคคล</p>'; return; }

  const labels = { gender:'เพศ', age:'อายุ', marital_status:'สถานภาพสมรส', education:'การศึกษา', hospital_level:'ระดับโรงพยาบาล', position:'ตำแหน่ง', work_experience:'ประสบการณ์', pc_experience:'ประสบการณ์ PC', pc_training:'อบรม PC' };
  const maps = {
    gender: { male:'ชาย', female:'หญิง' },
    marital_status: { single:'โสด', married:'สมรส', divorced:'หย่าร้าง', widowed:'หม้าย', separated:'แยก' },
    education: { bachelor:'ปริญญาตรี', master:'ปริญญาโท', doctorate:'ปริญญาเอก' },
    hospital_level: { community:'ชุมชน', general:'ทั่วไป', center:'ศูนย์' },
    position: { head:'หัวหน้า', chief_ward:'หัวหน้าหอผู้ป่วย', deputy_chief:'รองหัวหน้า', nurse:'พยาบาล' },
    pc_experience: { yes:'เคย', no:'ไม่เคย' },
    pc_training: { yes:'เคย', no:'ไม่เคย' }
  };
  const fmt = (k,v) => {
    if (maps[k] && maps[k][v]) return maps[k][v];
    if (k==='age'||k==='work_experience') return `${v} ปี`;
    return v;
  };

  container.innerHTML = Object.entries(info)
    .filter(([k]) => k !== 'training_course')
    .map(([k,v]) => `<div class="bg-gray-50 rounded-lg p-3"><p class="text-xs text-gray-500">${labels[k]||k}</p><p class="font-medium text-gray-800">${fmt(k,v)}</p></div>`)
    .join('');

  if (info.training_course) {
    container.innerHTML += `<div class="col-span-2 sm:col-span-3 bg-blue-50 rounded-lg p-3"><p class="text-xs text-blue-600">หลักสูตรการอบรม</p><p class="font-medium text-blue-800">${info.training_course}</p></div>`;
  }
}

// ==================== EVENT LISTENERS ====================
document.getElementById('logout-btn')?.addEventListener('click', () => {
  currentUser = null;
  document.getElementById('license-input').value = '';
  showPage('login-page');
});
document.getElementById('back-to-timeline')?.addEventListener('click', () => showTimeline());
document.getElementById('back-to-timeline-from-dashboard')?.addEventListener('click', () => showTimeline());
document.getElementById('prev-section-btn')?.addEventListener('click', () => {
  const startSection = currentUser.personalInfo ? 2 : 1;
  if (currentSection > startSection) showSection(currentSection - 1);
});
document.getElementById('next-section-btn')?.addEventListener('click', () => {
  if (validateSection(currentSection)) showSection(currentSection + 1);
});
document.getElementById('submit-btn')?.addEventListener('click', submitAssessment);
document.getElementById('view-dashboard-btn')?.addEventListener('click', showDashboard);
document.getElementById('modal-close-btn')?.addEventListener('click', hideModal);
document.getElementById('modal-overlay')?.addEventListener('click', e => { if (e.target === e.currentTarget) hideModal(); });

document.addEventListener('change', e => {
  if (e.target.name === 'marital_status') {
    document.querySelector('[name=marital_status_other]').style.display = e.target.value === 'other' ? 'block' : 'none';
  }
  if (e.target.name === 'hospital_level') {
    document.querySelector('[name=hospital_level_other]').style.display = e.target.value === 'other' ? 'block' : 'none';
  }
  if (e.target.name === 'position') {
    document.querySelector('[name=position_other]').style.display = e.target.value === 'other' ? 'block' : 'none';
  }
});

// ==================== INIT ====================
initLogin();
</script>
</body>
</html>
